<%inherit file="/base.html"/>
<%def name="scripts()">
    <% charts_by = request.GET["charts_by"] if "charts_by" in request.GET else "yahoo" %>
    % if charts_by == "google":
        <% from django.db.models import Count %>
        <script type="text/javascript">
            google.load("visualization", "1", {packages:["piechart"]});
            % for question in survey.questions.all():
                google.setOnLoadCallback(drawChart${question.id});
                function drawChart${question.id}() {
                    var data = new google.visualization.DataTable();
                    data.addColumn('string', 'Answer');
                    data.addColumn('number', 'Count');
                    <% answerI = 0 %>
                    % for answer in question.answer_set.values('text_answer').annotate(count=Count("id")).order_by():
                        data.addRows(1);
                        data.setValue(${answerI}, 0, "${answer["text_answer"].replace('"', r'\"')}");
                        data.setValue(${answerI}, 1, ${answer["count"]});
                        <% answerI += 1 %>
                    % endfor
                    var chart = new google.visualization.PieChart(document.getElementById('chart${question.id}'));
                    chart.draw(data, {legendFontSize: 12, legend: "left", height: 300, width: 600,
                        is3D: true, title: "${question.question.replace('"', r'\"')}"});
                }
            % endfor
        </script>
    % elif charts_by == "yahoo":
        <link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/2.8.0r4/build/fonts/fonts-min.css" />
        <script type="text/javascript" src="http://yui.yahooapis.com/2.8.0r4/build/yahoo-dom-event/yahoo-dom-event.js"></script>
        <script type="text/javascript" src="http://yui.yahooapis.com/2.8.0r4/build/json/json-min.js"></script>
        <script type="text/javascript" src="http://yui.yahooapis.com/2.8.0r4/build/element/element-min.js"></script>
        <script type="text/javascript" src="http://yui.yahooapis.com/2.8.0r4/build/datasource/datasource-min.js"></script>
        <script type="text/javascript" src="http://yui.yahooapis.com/2.8.0r4/build/swf/swf-min.js"></script>
        <script type="text/javascript" src="http://yui.yahooapis.com/2.8.0r4/build/charts/charts-min.js"></script>
    % endif
</%def>

<%def name="css()">
    <% charts_by = request.GET["charts_by"] if "charts_by" in request.GET else "yahoo" %>
    % if charts_by == "yahoo":
        <style type="text/css">
            .chart_div {
                width: 600px;
                height: 300px;
            }
        </style>
    % endif
</%def>

<% charts_by = request.GET["charts_by"] if "charts_by" in request.GET else "yahoo" %>
<h1>${survey.title}</h1>
<p>${survey.description}</p>
% for question in survey.questions.all():
    ## Google charts kind of need a title, as their rendering is a little wonky at times. Hence,
    ## put the title in the chart for Google. We don't have to do that with Yahoo.
    % if charts_by == "yahoo":
        <h2>${question.question}</h2>
    % endif
    <p>
        <div class="chart_div" id="chart${question.id}">
            % if charts_by == "yahoo":
                Unable to load Flash content. The YUI Charts Control requires Flash Player 9.0.45 or higher. You can install the latest version at the 
                <a href="http://www.adobe.com/go/getflashplayer">Adobe Flash Player Download Center</a>.</p>
            % endif
        </div>

        % if charts_by == "yahoo":
            <script type="text/javascript">
                <%
                    from django.db.models import Count
                    answers = question.answer_set.values('text_answer').annotate(count=Count("id")).order_by()
                    answers = [(answer["text_answer"].replace('"', r'\"'), answer["count"],) for answer in answers]
                    answers = ",\n".join(["{ response: \"%s\", count: %d }" % answer for answer in answers])
                %>
                YAHOO.widget.Chart.SWFURL = "http://yui.yahooapis.com/2.8.0r4/build/charts/assets/charts.swf";
                var data${question.id} = new YAHOO.util.DataSource([${answers}]);
                data${question.id}.responseType = YAHOO.util.DataSource.TYPE_JSARRAY;
                data${question.id}.responseSchema = { fields: [ "response", "count" ] };

                var chart${question.id} = new YAHOO.widget.PieChart("chart${question.id}", data${question.id}, {
                    dataField: "count",
                    categoryField: "response",
                    style: {
                        padding: 20,
                        legend: {
                            display: "right",
                            padding: 10,
                            spacing: 5,
                            font: {
                                family: "Arial",
                                size: 13
                            }
                        }
                    }, expressInstall: "assets/expressinstall.swf"
                });
            </script>
        % endif
    </p>
% endfor
